<div 
  class="flex flex-col h-full rounded-2xl border transition-all duration-500 w-full" 
  [class.opacity-40]="isPastDay()"
  [class.bg-planner-card]="dayIndex() === taskService.currentDayIndex() && taskService.weekOffset() === 0"
  [class.border-white/10]="dayIndex() === taskService.currentDayIndex() && taskService.weekOffset() === 0"
  [class.bg-transparent]="dayIndex() !== taskService.currentDayIndex() || taskService.weekOffset() !== 0"
  [class.border-transparent]="dayIndex() !== taskService.currentDayIndex() || taskService.weekOffset() !== 0"
  [class.hover:bg-white/5]="dayIndex() !== taskService.currentDayIndex()"
  role="region"
>
    <!-- Day Header & Capacity -->
    <div class="flex-shrink-0" style="height: 7.5rem;">
      <header class="text-center py-3 flex-shrink-0">
         <div class="flex justify-center items-center h-4 mb-1">
           @if(dayIndex() === taskService.currentDayIndex() && taskService.weekOffset() === 0) {
             <span class="w-1.5 h-1.5 bg-emerald-400 rounded-full animate-pulse"></span>
           }
        </div>
        <h3 class="font-medium text-sm text-planner-text tracking-wide" [class.text-emerald-400]="dayIndex() === taskService.currentDayIndex() && taskService.weekOffset() === 0" [class.font-bold]="dayIndex() === taskService.currentDayIndex() && taskService.weekOffset() === 0">
          {{ day().slice(0, 3) }}
        </h3>
        <div class="text-xs text-planner-text-dim mt-1 font-mono opacity-70">{{ taskService.weekDates()[dayIndex()] }}</div>
      </header>
      
      <div class="px-4 pb-4 flex-shrink-0">
         <div class="flex items-end justify-between mb-1">
            <span class="text-[10px] text-planner-text-dim font-mono">{{ taskService.dailyLoad()[day()].total }}m</span>
            <span class="text-[10px] text-planner-text-dim font-mono">{{ taskService.dailyLoad()[day()].percentage | number:'1.0-0' }}%</span>
         </div>
        <div class="w-full h-1 bg-planner-surface rounded-full overflow-hidden">
          <div class="h-full transition-all duration-700 ease-out rounded-full shadow-[0_0_10px_rgba(255,255,255,0.2)]"
            [style.width.%]="taskService.dailyLoad()[day()].percentage"
            [style.background-color]="taskService.dailyLoad()[day()].color">
          </div>
        </div>
      </div>
    </div>

    <!-- Unified Task Slots Container -->
    <div class="flex-grow min-h-0 px-2 pb-2 overflow-y-auto custom-scrollbar space-y-1">
      @for(cat of categories; track cat) {
        <div
          (dragover)="$event.preventDefault()" 
          (drop)="handleDrop($event, cat)" 
          (dragenter)="taskService.onDragEnter({ type: 'day', day: day(), category: cat })"
          class="rounded-xl transition-all duration-200"
          [class.ring-1]="isDropTarget(cat)"
          [class.bg-cat-asap/10]="cat === 'goal' && isDropTarget(cat)" [class.ring-cat-asap/50]="cat === 'goal' && isDropTarget(cat)"
          [class.bg-cat-soon/10]="cat === 'focus' && isDropTarget(cat)" [class.ring-cat-soon/50]="cat === 'focus' && isDropTarget(cat)"
          [class.bg-cat-pending/10]="cat === 'core' && isDropTarget(cat)" [class.ring-cat-pending/50]="cat === 'core' && isDropTarget(cat)"
          [class.bg-cat-offtime/10]="cat === 'offTime' && isDropTarget(cat)" [class.ring-cat-offtime/50]="cat === 'offTime' && isDropTarget(cat)"
          [class.bg-cat-chore/10]="cat === 'chore' && isDropTarget(cat)" [class.ring-cat-chore/50]="cat === 'chore' && isDropTarget(cat)"
        >
          <div class="space-y-1.5 p-1.5">
            <!-- Render tasks if they exist -->
            @for(todo of taskService.week()[day()][cat]; track todo.id) {
                 <div 
                  [draggable]="taskService.editingTaskId() !== todo.id" 
                  (dragstart)="taskService.editingTaskId() !== todo.id && onWeekDragStart($event, todo, cat)" 
                  (dblclick)="taskService.editingTaskId() !== todo.id && taskService.startEdit(todo)"
                  class="relative h-14 px-3 flex items-center justify-between rounded-lg bg-planner-surface border border-l-4 border-white/5 transition-all shadow-sm hover:shadow-md group overflow-hidden flex-shrink-0" 
                  [class.animate-card-success-pop]="taskService.justCompletedTaskId() === todo.id"
                  [class.border-l-cat-asap]="cat === 'goal' && !todo.completed"
                  [class.border-l-cat-soon]="cat === 'focus' && !todo.completed"
                  [class.border-l-cat-pending]="cat === 'core' && !todo.completed"
                  [class.border-l-cat-offtime]="cat === 'offTime' && !todo.completed"
                  [class.border-l-cat-chore]="cat === 'chore' && !todo.completed"
                  [class.border-l-emerald-500]="todo.completed"
                  [class.border-emerald-500/40]="todo.completed"
                  [class.bg-emerald-900/30]="todo.completed"
                  role="button">
                  
                   @if(taskService.editingTaskId() === todo.id) {
                      <div class="flex items-center gap-1 w-full z-10">
                        <input type="text" [(ngModel)]="taskService.editingTaskText" (keydown.enter)="taskService.saveEdit()" (keydown.escape)="taskService.cancelEdit()" class="flex-grow min-w-0 bg-transparent text-sm focus:outline-none border-b border-white/20" autoFocus>
                        <input type="number" [(ngModel)]="taskService.editingTaskDuration" (keydown.enter)="taskService.saveEdit()" (keydown.escape)="taskService.cancelEdit()" class="w-8 bg-transparent text-xs text-right focus:outline-none border-b border-white/20 font-mono text-planner-text-dim" placeholder="m">
                      </div>
                   } @else {
                      <div class="flex-grow min-w-0 mr-2 z-10">
                        <span class="text-xs font-medium text-planner-text truncate block transition-all duration-300" [class.line-through]="todo.completed" [class.text-emerald-200/90]="todo.completed">{{ todo.text }}</span>
                      </div>
                      <div class="flex items-center gap-2 flex-shrink-0 z-10">
                         <span class="text-[9px] font-mono font-bold px-1.5 py-0.5 rounded transition-opacity border"
                         [class.opacity-60]="!todo.completed"
                         [class.group-hover:opacity-100]="!todo.completed"
                         [class.text-cat-asap]="cat === 'goal' && !todo.completed" [class.bg-cat-asap/10]="cat === 'goal' && !todo.completed" [class.border-cat-asap/20]="cat === 'goal' && !todo.completed"
                         [class.text-cat-soon]="cat === 'focus' && !todo.completed" [class.bg-cat-soon/10]="cat === 'focus' && !todo.completed" [class.border-cat-soon/20]="cat === 'focus' && !todo.completed"
                         [class.text-cat-pending]="cat === 'core' && !todo.completed" [class.bg-cat-pending/10]="cat === 'core' && !todo.completed" [class.border-cat-pending/20]="cat === 'core' && !todo.completed"
                         [class.text-cat-offtime]="cat === 'offTime' && !todo.completed" [class.bg-cat-offtime/10]="cat === 'offTime' && !todo.completed" [class.border-cat-offtime/20]="cat === 'offTime' && !todo.completed"
                         [class.text-cat-chore]="cat === 'chore' && !todo.completed" [class.bg-cat-chore/10]="cat === 'chore' && !todo.completed" [class.border-cat-chore/20]="cat === 'chore' && !todo.completed"
                         [class.text-emerald-300/80]="todo.completed" [class.bg-emerald-400/10]="todo.completed" [class.border-emerald-400/20]="todo.completed"
                         >{{todo.duration}}m</span>
                         
                         <button (click)="taskService.toggleTodoCompletion(day(), cat, todo.id)" class="w-5 h-5 rounded-full flex items-center justify-center transition-all duration-300 border-2"
                             [class.border-white/10]="!todo.completed" 
                             [class.hover:border-emerald-400]="!todo.completed"
                             [class.border-emerald-400]="todo.completed"
                             [class.bg-emerald-400]="todo.completed"
                             [class.scale-110]="todo.completed">
                             <svg class="w-3.5 h-3.5 text-planner-bg transition-all duration-300" 
                                [class.scale-0]="!todo.completed" 
                                [class.scale-100]="todo.completed"
                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="20 6 9 17 4 12"></polyline>
                             </svg>
                         </button>
                      </div>
                   }
                </div>
            }
            <!-- Render remaining ghost slots -->
            @for(_ of getRemainingSlotsForCategory(cat); track $index) {
              <div class="h-14 w-full border-2 border-dashed border-white/10 rounded-lg flex items-center justify-center text-xs text-planner-text-dim uppercase tracking-wider font-semibold opacity-40">
                <span>{{ cat === 'offTime' ? 'Off Time' : cat }}</span>
              </div>
            }
          </div>
        </div>
      }
    </div>
</div>