<div 
  class="flex flex-col h-full rounded-2xl border-2 border-transparent hover:bg-white/5 transition-all duration-500 w-full"
  [class.opacity-75]="!isCurrentDay()"
  role="region"
>
    <!-- Day Header & Capacity -->
    <div class="flex-shrink-0" style="height: 7.5rem;">
      <header class="text-center py-3 flex-shrink-0">
         <div class="flex justify-center items-center h-4 mb-1">
           <!-- Indicator dot removed -->
        </div>
        <h3 class="font-medium text-sm tracking-wide text-white" [class.opacity-75]="!isCurrentDay()" [class.font-bold]="isCurrentDay()">
          {{ day().slice(0, 3) }}
        </h3>
        <div class="text-sm mt-1 font-mono text-white" [class.opacity-75]="!isCurrentDay()">{{ taskService.weekDates()[dayIndex()] }}</div>
      </header>
      
      <div class="px-4 pb-4 flex-shrink-0">
         <div class="flex items-end justify-between mb-1">
            <span class="text-sm font-mono text-white" [class.opacity-75]="!isCurrentDay()">{{ taskService.dailyLoad()[day()].total }}m</span>
            <span class="text-sm font-mono text-white" [class.opacity-75]="!isCurrentDay()">{{ taskService.dailyLoad()[day()].percentage | number:'1.0-0' }}%</span>
         </div>
        <div class="w-full h-1 bg-planner-surface rounded-full overflow-hidden">
          <div class="h-full transition-all duration-700 ease-out rounded-full shadow-[0_0_10px_rgba(255,255,255,0.2)]"
            [style.width.%]="taskService.dailyLoad()[day()].percentage"
            [style.background-color]="taskService.dailyLoad()[day()].color">
          </div>
        </div>
      </div>
    </div>

    <!-- Unified Task Slots Container -->
    <div class="flex-grow min-h-0 px-2 pb-2 overflow-y-auto custom-scrollbar space-y-3">
      @for(cat of categories; track cat) {
        <div
          (dragover)="$event.preventDefault()" 
          (drop)="handleDrop($event, cat)" 
          (dragenter)="taskService.onDragEnter({ type: 'day', day: day(), category: cat })"
          class="rounded-xl transition-all duration-200"
          [class.ring-1]="isDropTarget(cat)"
          [class.bg-cat-asap/10]="cat === 'goal' && isDropTarget(cat)" [class.ring-cat-asap/50]="cat === 'goal' && isDropTarget(cat)"
          [class.bg-cat-soon/10]="cat === 'focus' && isDropTarget(cat)" [class.ring-cat-soon/50]="cat === 'focus' && isDropTarget(cat)"
          [class.bg-cat-pending/10]="cat === 'work' && isDropTarget(cat)" [class.ring-cat-pending/50]="cat === 'work' && isDropTarget(cat)"
          [class.bg-cat-leisure/10]="cat === 'leisure' && isDropTarget(cat)" [class.ring-cat-leisure/50]="cat === 'leisure' && isDropTarget(cat)"
          [class.bg-cat-basics/10]="cat === 'basics' && isDropTarget(cat)" [class.ring-cat-basics/50]="cat === 'basics' && isDropTarget(cat)"
        >
          <div class="space-y-1.5 p-[1.375rem]">
            <!-- Render tasks if they exist -->
            @for(todo of taskService.week()[day()][cat]; track todo.id) {
                 <div 
                  [draggable]="taskService.editingTaskId() !== todo.id" 
                  (dragstart)="taskService.editingTaskId() !== todo.id && onWeekDragStart($event, todo, cat)" 
                  (dblclick)="taskService.editingTaskId() !== todo.id && taskService.startEdit(todo)"
                  class="relative h-12 px-3 flex items-center justify-between rounded-lg border bg-transparent transition-all shadow-sm hover:shadow-md group flex-shrink-0" 
                  [class.animate-card-success-pop]="taskService.justCompletedTaskId() === todo.id"
                  [class.bg-emerald-900/30]="todo.completed"
                  [class.border-white/10]="!isCurrentDay() && !todo.completed"
                  [class.border-cat-asap]="cat === 'goal' && !todo.completed && isCurrentDay()"
                  [class.border-cat-soon]="cat === 'focus' && !todo.completed && isCurrentDay()"
                  [class.border-cat-pending]="cat === 'work' && !todo.completed && isCurrentDay()"
                  [class.border-cat-leisure]="cat === 'leisure' && !todo.completed && isCurrentDay()"
                  [class.border-cat-basics]="cat === 'basics' && !todo.completed && isCurrentDay()"
                  [class.border-emerald-500]="todo.completed"
                  role="button">
                  
                   @if(taskService.editingTaskId() === todo.id) {
                      <div class="flex items-center gap-1 w-full z-10">
                        <input type="text" [(ngModel)]="taskService.editingTaskText" (keydown.enter)="taskService.saveEdit()" (keydown.escape)="taskService.cancelEdit()" class="flex-grow min-w-0 bg-transparent text-sm focus:outline-none border-b border-white/20" autoFocus>
                        <input type="number" [(ngModel)]="taskService.editingTaskDuration" (keydown.enter)="taskService.saveEdit()" (keydown.escape)="taskService.cancelEdit()" class="w-8 bg-transparent text-sm text-right focus:outline-none border-b border-white/20 font-mono text-planner-text-dim" placeholder="m">
                      </div>
                   } @else {
                      <span class="text-sm font-medium truncate transition-all duration-300 flex-grow"
                          [class.line-through]="todo.completed"
                          [class.text-white]="!todo.completed"
                          [class.opacity-75]="!isCurrentDay() && !todo.completed"
                          [class.text-emerald-300]="todo.completed">
                          {{ todo.text }} ({{ todo.duration }})
                      </span>
                      
                      <button (click)="taskService.toggleTodoCompletion(day(), cat, todo.id)" class="w-4 h-4 rounded flex-shrink-0 flex items-center justify-center transition-all duration-300 border"
                         [class.border-white/30]="!todo.completed" 
                         [class.hover:border-emerald-400]="!todo.completed"
                         [class.border-emerald-500]="todo.completed"
                         [class.bg-emerald-500]="todo.completed">
                         <svg class="w-3 h-3 text-planner-bg transition-all duration-300" 
                            [class.scale-0]="!todo.completed" 
                            [class.scale-100]="todo.completed"
                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                         </svg>
                      </button>
                   }
                </div>
            }
            <!-- Render remaining ghost slots -->
            @for(_ of getRemainingSlotsForCategory(cat); track $index) {
              <div class="h-12 w-full border border-dashed border-white/10 rounded-lg flex items-center justify-center text-sm uppercase tracking-wider font-semibold opacity-40">
                 <span class="text-white" [class.opacity-75]="!isCurrentDay()">
                    {{ cat.toUpperCase() }}
                  </span>
              </div>
            }
          </div>
        </div>
      }
    </div>
</div>